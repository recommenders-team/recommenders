parameters:
  conda_env: #
  test_type: unit # | smoke | integration | notebooks
  test_string: #
  name: #
  spark: not spark # | spark
  gpu: not gpu # | gpu

steps:
  - script: |
      . /anaconda/etc/profile.d/conda.sh
      conda activate ${{parameters.conda_env}}

      echo "${{parameters.name}} tests"
      pytest tests/${{parameters.test_type}} \
        --durations 0 \
        -m "${{coalesce (parameters.test_string, parameters.test_type)}} and ${{parameters.spark}} and  ${{parameters.gpu}}" \
        --junitxml=reports/test-unit.xml

      conda deactivate
    displayName: 'Run ${{coalesce (parameters.name, parameters.test_type)}} Tests'
    env:
      ${{ if eq(spark, 'spark') }}:
        PYSPARK_PYTHON: /anaconda/envs/${{parameters.conda_env}}/bin/python
        PYSPARK_DRIVER_PYTHON: /anaconda/envs/${{parameters.conda_env}}/bin/python
