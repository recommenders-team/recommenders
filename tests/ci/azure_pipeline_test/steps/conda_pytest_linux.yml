parameters:
  conda_env: #
  test_type: unit # | smoke | integration | notebooks
  test_string: ${{paramaters.test_type}}
  name: ${{paramaters.test_type}}
  spark: not spark # | spark
  gpu: not gpu # | gpu

steps:
  - script: |
      . /anaconda/etc/profile.d/conda.sh
      conda activate ${{parameters.conda_env}}

      echo "${{parameters.name}} tests"
      pytest tests/${{parameters.test_type}} \
        --durations 0 \
        -m "${{parameters.test_string}} and ${{parameters.spark}} and  ${{parameters.gpu}}" \
        --junitxml=reports/test-unit.xml

      conda deactivate
    displayName: 'Run ${{parameters.name}} Tests'
    - ${{ if eq(parameters.spark, 'spark') }}:
      env:
        PYSPARK_PYTHON: /anaconda/envs/${{parameters.conda_env}}/bin/python
        PYSPARK_DRIVER_PYTHON: /anaconda/envs/${{parameters.conda_env}}/bin/python

  - task: PublishTestResults@2
    displayName: 'Publish Test Results '
    inputs:
      testResultsFiles: '**/test-*.xml'
      failTaskOnFailedTests: true
    condition: succeededOrFailed()