# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
#
# A Github Service Connection must also be created with the name "AI-GitHub"
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/demands?view=azure-devops&tabs=yaml

resources:
  repositories:
    - repository: aitemplates
      type: github
      name: microsoft/AI
      endpoint: AI-GitHub

schedules:
- cron: "7 4 * * *"
  displayName: Nightly build master
  branches:
    include:
    - master
  always: true
- cron: "7 16 * * *"
  displayName: Nightly build staging
  branches:
    include:
    - staging
  always: true

trigger: none

pr: none

variables:
- group: LinuxAgentPool

jobs:
- job: nightly
  displayName: 'Nightly tests Linux GPU'
  timeoutInMinutes: 180 # how long to run the job before automatically cancelling
  pool:
    name: $(Agent_Pool)

  steps:
  - template: .ci/steps/reco_config_conda_linux.yml@aitemplates
    parameters:
      conda_env: nightly_reco_gpu

  - template: steps/conda_pytest_linux.yml
    parameters:
      conda_env: nightly_reco_gpu
      gpu: gpu
      smoke_tests: true
      integration_tests: true

  - template: .ci/steps/reco_conda_clean_linux.yml@aitemplates
    parameters:
      conda_env: nightly_reco_gpu
