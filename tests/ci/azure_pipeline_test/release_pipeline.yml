# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Pull request against these branches will trigger this build
pr: none

# A new tag will trigger the build
trigger:
- pipeline_release
  # tags:
  #   include:
  #   - *

variables:
- group: LinuxAgentPool

jobs:
- template: dsvm_linux_template.yml
  parameters:
    test_types:
    - unit
    task_name: "Test - Unit Linux CPU"
    conda_env: "relase_unit_linux_cpu"
    conda_opts: "python=3.6"
    pip_opts: ""
    pytest_markers: "not notebooks and not spark and not gpu"
    install: "release"

# - template: dsvm_linux_template.yml
#   parameters:
#     test_types:
#     - unit
#     task_name: "Test - Unit Notebook Linux CPU"
#     conda_env: "relase_unit_notebook_linux_cpu"
#     conda_opts: "python=3.6"
#     pip_opts: "[examples]"
#     pytest_markers: "notebooks and not spark and not gpu"

# - template: dsvm_linux_template.yml
#   parameters:
#     test_types:
#     - unit
#     task_name: "Test - Unit Linux GPU"
#     conda_env: "relase_unit_linux_gpu"
#     conda_opts: "python=3.6 cudatoolkit=10.0 \"cudnn>=7.6\""
#     pip_opts: "[gpu] -f https://download.pytorch.org/whl/cu100/torch_stable.html"
#     pytest_markers: "not notebooks and not spark and gpu"

# - template: dsvm_linux_template.yml
#   parameters:
#     test_types:
#     - unit
#     task_name: "Test - Unit Notebook Linux GPU"
#     conda_env: "relase_unit_notebook_linux_gpu"
#     conda_opts: "python=3.6 cudatoolkit=10.0 \"cudnn>=7.6\""
#     pip_opts: "[gpu,examples]  -f https://download.pytorch.org/whl/cu100/torch_stable.html"
#     pytest_markers: "notebooks and not spark and gpu"

# - template: dsvm_linux_template.yml
#   parameters:
#     test_types:
#     - unit
#     task_name: "Test - Unit Linux Spark"
#     conda_env: "relase_unit_linux_spark"
#     conda_opts: "python=3.6"
#     pip_opts: "[spark]"
#     pytest_markers: "not notebooks and spark and not gpu"

# - template: dsvm_linux_template.yml
#   parameters:
#     test_types:
#     - unit
#     task_name: "Test - Unit Notebook Linux Spark"
#     conda_env: "relase_unit_notebook_linux_spark"
#     conda_opts: "python=3.6"
#     pip_opts: "[spark,examples]"
#     pytest_markers: "notebooks and spark and not gpu"

- job: Package
  dependsOn:
  - relase_unit_linux_cpu
  # - relase_unit_notebook_linux_cpu
  # - relase_unit_linux_gpu
  # - relase_unit_notebook_linux_gpu
  # - relase_unit_linux_spark
  # - relase_unit_notebook_linux_spark
  condition: succeeded()
  steps:
    # Create archives with complete source code included
  - task: ArchiveFiles@2
    displayName: Create zip archive of reco_utils
    condition: succeeded() #and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    inputs:
      rootFolderOrFile: $(Build.SourcesDirectory)/reco_utils
      includeRootFolder: false
      archiveType: zip
      archiveFile: '$(Build.ArtifactStagingDirectory)/archives/Recommenders-reco_utils_code.zip'
      replaceExistingArchive: true
  - task: ArchiveFiles@2
    displayName: Create tar.gz archive of reco_utils
    condition: succeeded() #and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    inputs:
      rootFolderOrFile: $(Build.SourcesDirectory)/reco_utils
      includeRootFolder: false
      archiveType: tar
      tarCompression: gz
      archiveFile: '$(Build.ArtifactStagingDirectory)/archives/Recommenders-reco_utils_code.tar.gz'
      replaceExistingArchive: true
  - task: ArchiveFiles@2
    displayName: Create zip archive of examples
    condition: succeeded() #and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    inputs:
      rootFolderOrFile: $(Build.SourcesDirectory)/examples
      includeRootFolder: false
      archiveType: zip
      archiveFile: '$(Build.ArtifactStagingDirectory)/archives/Recommenders-example_notebooks.zip'
      replaceExistingArchive: true
  - task: ArchiveFiles@2
    displayName: Create tar.gz archive of examples
    condition: succeeded() #and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    inputs:
      rootFolderOrFile: $(Build.SourcesDirectory)/examples
      includeRootFolder: false
      archiveType: tar
      tarCompression: gz
      archiveFile: '$(Build.ArtifactStagingDirectory)/archives/Recommenders-example_notebooks.tar.gz'
      replaceExistingArchive: true
  - script: |
      ARTIFACTS_DIRECTORY=/home/vsts/work/artifacts
      echo "   --- COPY ARTIFACTS ---"
      mkdir -p $BUILD_ARTIFACTSTAGINGDIRECTORY/binaries || exit -1
      cp $ARTIFACTS_DIRECTORY/reco_utils*.whl $BUILD_ARTIFACTSTAGINGDIRECTORY/binaries || exit -1
      echo "   --- LIST OF ARTIFACTS ---"
      echo "Artifact folder: $BUILD_ARTIFACTSTAGINGDIRECTORY"
      du -a $BUILD_ARTIFACTSTAGINGDIRECTORY
    displayName: 'List artifacts'
  - task: GitHubRelease@0 # Documentation: https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/github-release?view=azure-devops
    displayName: 'Create GitHub Release'
    condition: succeeded() #and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    inputs:
      gitHubConnection: recommenders_release
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'manual'
      tag: '$(tagName)'
      title: 'Recommenders'
      assets: |
        $(Build.ArtifactStagingDirectory)/binaries/*
        $(Build.ArtifactStagingDirectory)/archives/*
      assetUploadMode: 'delete'
      isDraft: true
      isPreRelease: false
      addChangeLog: false